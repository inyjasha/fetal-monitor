#!/bin/bash

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Fetal Monitor System..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
ARCH=$(uname -m)
echo "üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã: $ARCH"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–∫–æ–π compose —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
if [[ "$ARCH" == "arm"* ]] || [[ "$ARCH" == "aarch"* ]]; then
    COMPOSE_FILE="docker-compose.arm.yml"
    echo "üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º ARM-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
else
    COMPOSE_FILE="docker-compose.yml"
    echo "üéØ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
fi

# –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
echo "üî® –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤..."
docker-compose -f $COMPOSE_FILE build

echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose -f $COMPOSE_FILE up -d

echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 30

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose -f $COMPOSE_FILE ps

echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üìä Frontend –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ: http://localhost"
echo "üîß API –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ: http://localhost:8001"
echo "üìà Health checks:"
echo "   Frontend: http://localhost/health"
echo "   ML Service: http://localhost:8001/api/ping"