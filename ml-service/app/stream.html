<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Fetal Monitor Stream</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  #log { 
    background: #111; 
    color: #0f0; 
    padding: 10px; 
    height: 300px; 
    overflow-y: scroll; 
    white-space: pre; 
  }
  #analysis {
    background: #f0f0f0;
    padding: 10px;
    margin-top: 20px;
    border: 1px solid #ccc;
  }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  table, th, td { border: 1px solid #aaa; padding: 4px; text-align: center; }
  th { background: #ddd; }
</style>
</head>
<body>
<h1>üì° –ü–æ—Ç–æ–∫–æ–≤–∞—è —Å–µ—Å—Å–∏—è Fetal Monitor</h1>

<label>Session ID: 
  <input id="sid" value="1">
</label>
<button onclick="startStream()">–°—Ç–∞—Ä—Ç —Å—Ç—Ä–∏–º–∞</button>

<h2>–î–∞–Ω–Ω—ã–µ</h2>
<pre id="log"></pre>

<h2>–ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏</h2>
<div id="analysis">–ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç", —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>

<script>
let ws;

async function startStream() {
    const sid = document.getElementById("sid").value;
    const log = document.getElementById("log");
    const analysisDiv = document.getElementById("analysis");
    log.textContent = "";
    analysisDiv.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π...";

    // 1. –ü–æ–¥–∫–ª—é—á–∞–µ–º WebSocket
    ws = new WebSocket(`ws://localhost:8001/ws/stream/${sid}`);

    ws.onmessage = function(event) {
        const msg = JSON.parse(event.data);
        if(msg.frame) {
            log.textContent += `–í—Ä–µ–º—è: ${msg.frame.time.toFixed(2)}s | BPM: ${msg.frame.bpm} | Uterus: ${msg.frame.uterus}\n`;
        } else if(msg.meta) {
            log.textContent += `=== META ===\n${JSON.stringify(msg.meta, null, 2)}\n`;
        }
        log.scrollTop = log.scrollHeight;
    };

    ws.onclose = function() {
        log.textContent += "\n‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ";
    };

    // 2. –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —á–µ—Ä–µ–∑ REST API
    try {
        const resp = await fetch(`http://localhost:8001/sessions/${sid}/analysis`);
        if (!resp.ok) {
            analysisDiv.textContent = "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: " + resp.statusText;
            return;
        }
        const data = await resp.json();

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –±–∞–∑–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        let html = `
          <b>Session:</b> ${data.meta.session_id} <br>
          <b>Group:</b> ${data.meta.group} <br>
        `;

        // –î–µ—Ü–µ–ª–µ—Ä–∞—Ü–∏–∏
        if(data.features.decelerations && data.features.decelerations.length > 0) {
            html += "<h3>–î–µ—Ü–µ–ª–µ—Ä–∞—Ü–∏–∏</h3><table><tr><th>–ù–∞—á–∞–ª–æ</th><th>–ö–æ–Ω–µ—Ü</th><th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th></tr>";
            data.features.decelerations.forEach(d => {
                html += `<tr><td>${d.start.toFixed(2)}</td><td>${d.end.toFixed(2)}</td><td>${d.duration.toFixed(2)}</td></tr>`;
            });
            html += "</table>";
        } else {
            html += "<p>–î–µ—Ü–µ–ª–µ—Ä–∞—Ü–∏–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</p>";
        }

        // –¢–∞—Ö–∏–∫–∞—Ä–¥–∏–∏
        if(data.features.tachy_indices && data.features.tachy_indices.length > 0) {
            html += `<h3>–¢–∞—Ö–∏–∫–∞—Ä–¥–∏–∏ (–≤—Å–µ–≥–æ ${data.features.tachy_indices.length})</h3>`;
            html += `<p>${data.features.tachy_indices.slice(0,50).join(", ")} ...</p>`;
        } else {
            html += "<p>–¢–∞—Ö–∏–∫–∞—Ä–¥–∏–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</p>";
        }

        analysisDiv.innerHTML = html;

    } catch (err) {
        analysisDiv.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞: " + err;
    }
}
</script>
</body>
</html>
