<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Fetal Monitor Stream</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  #log { 
    background: #111; 
    color: #0f0; 
    padding: 10px; 
    height: 300px; 
    overflow-y: scroll; 
    white-space: pre; 
    font-family: monospace;
  }
  #analysis, #predictions, #statistics, #patientInfo {
    background: #f0f0f0;
    padding: 10px;
    margin-top: 20px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  table, th, td { border: 1px solid #aaa; padding: 4px; text-align: center; }
  th { background: #ddd; }
  
  .risk-high { background-color: #ffcccc; padding: 5px; border-radius: 3px; }
  .risk-medium { background-color: #fff0cc; padding: 5px; border-radius: 3px; }
  .risk-low { background-color: #ccffcc; padding: 5px; border-radius: 3px; }
  
  .trend-rising { color: #ff4444; font-weight: bold; }
  .trend-falling { color: #4444ff; font-weight: bold; }
  .trend-stable { color: #44aa44; font-weight: bold; }
  
  .container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
  }
  
  .risk-factor {
    background: #ffcccc; 
    padding: 2px 5px; 
    margin: 2px; 
    border-radius: 3px; 
    display: inline-block;
    font-size: 0.9em;
  }
</style>
</head>
<body>
<h1>üì° –ü–æ—Ç–æ–∫–æ–≤–∞—è —Å–µ—Å—Å–∏—è Fetal Monitor</h1>

<label>Session ID: 
  <input id="sid" value="1">
</label>
<button onclick="startStream()">–°—Ç–∞—Ä—Ç —Å—Ç—Ä–∏–º–∞</button>
<button onclick="stopStream()" style="background-color: #ffcccc;">–°—Ç–æ–ø</button>

<h2>–î–∞–Ω–Ω—ã–µ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h2>
<pre id="log"></pre>

<div class="container">
  <div>
    <h2>üìä –¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div id="statistics">–ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç", —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
  </div>
  
  <div>
    <h2>üîÆ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–∏</h2>
    <div id="predictions">–ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç", —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
  </div>
</div>

<div class="container">
  <div>
    <h2>üë©‚Äç‚öïÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–∞—Ü–∏–µ–Ω—Ç–∫–µ</h2>
    <div id="patientInfo">–ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç", —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
  </div>
  
  <div>
    <h2>üìà –ê–Ω–∞–ª–∏–∑ –ø–æ –≤—Å–µ–π —Å–µ—Å—Å–∏–∏</h2>
    <div id="analysis">–ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç", —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å</div>
  </div>
</div>

<script>
let ws;
let isStreaming = false;

function updateStatistics(prediction) {
    const statsDiv = document.getElementById("statistics");
    const stats = prediction.statistics;
    
    let html = `
        <table>
            <tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>
            <tr><td>–¢–µ–∫—É—â–∏–π BPM</td><td>${stats.current_bpm?.toFixed(1) ?? "‚Äî"}</td></tr>
            <tr><td>–°—Ä–µ–¥–Ω–∏–π BPM (1 –º–∏–Ω)</td><td>${stats.mean_bpm_1min?.toFixed(1) ?? "‚Äî"}</td></tr>
            <tr><td>–ú–µ–¥–∏–∞–Ω–∞ BPM (1 –º–∏–Ω)</td><td>${stats.median_bpm_1min?.toFixed(1) ?? "‚Äî"}</td></tr>
            <tr><td>–¢–æ—á–µ–∫ –≤ –±—É—Ñ–µ—Ä–µ</td><td>${stats.samples_in_buffer ?? 0}</td></tr>
        </table>
    `;
    statsDiv.innerHTML = html;
}

function updatePredictions(prediction) {
    const predsDiv = document.getElementById("predictions");
    const trend = prediction.trend;
    const risk = prediction.risk;
    
    const trendClass = `trend-${trend.trend}`;
    const riskClass = `risk-${risk.risk_level}`;
    
    let html = `
        <h3>üìà –¢—Ä–µ–Ω–¥</h3>
        <div class="${trendClass}">
            <strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${trend.trend}<br>
            <strong>–ù–∞–∫–ª–æ–Ω:</strong> ${trend.slope?.toFixed(4) ?? 0}<br>
            <strong>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å:</strong> ${(trend.confidence * 100)?.toFixed(1) ?? 0}%
        </div>
        
        <h3>‚ö†Ô∏è –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞</h3>
        <div class="${riskClass}">
            <strong>–£—Ä–æ–≤–µ–Ω—å:</strong> ${risk.risk_level}<br>
            <strong>–°—á–µ—Ç:</strong> ${(risk.score * 100)?.toFixed(1) ?? 0}%<br>
            <strong>–§–∞–∫—Ç–æ—Ä—ã:</strong> ${risk.factors.join(", ") || "–Ω–µ—Ç"}
        </div>
        
        <table style="margin-top: 10px;">
            <tr><th>–í–∞—Ä–∏–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</th><th>–¢–µ–∫—É—â–∏–π BPM</th></tr>
            <tr>
                <td>${risk.variability?.toFixed(2) ?? "‚Äî"}</td>
                <td>${risk.current_bpm?.toFixed(1) ?? "‚Äî"}</td>
            </tr>
        </table>
    `;
    predsDiv.innerHTML = html;
}

function updatePatientInfo(patientData) {
    const patientDiv = document.getElementById("patientInfo");
    
    const riskFactors = patientData.risk_factors || {};
    const activeRisks = Object.entries(riskFactors)
        .filter(([_, isActive]) => isActive)
        .map(([factor, _]) => factor);
    
    let html = `
        <table>
            <tr><th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th><th>–ó–Ω–∞—á–µ–Ω–∏–µ</th></tr>
            <tr><td>–í–æ–∑—Ä–∞—Å—Ç</td><td>${patientData.age ?? "‚Äî"} –ª–µ—Ç</td></tr>
            <tr><td>–°—Ä–æ–∫ –±–µ—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏</td><td>${patientData.gestation_weeks ?? "‚Äî"} –Ω–µ–¥–µ–ª—å</td></tr>
            <tr><td>pH –∫—Ä–æ–≤–∏</td><td>${patientData.Ph ?? "‚Äî"}</td></tr>
            <tr><td>–ì–ª—é–∫–æ–∑–∞</td><td>${patientData.Glu ?? "‚Äî"} mmol/L</td></tr>
            <tr><td>–õ–∞–∫—Ç–∞—Ç</td><td>${patientData.LAC ?? "‚Äî"} mmol/L</td></tr>
            <tr><td>BE</td><td>${patientData.BE ?? "‚Äî"}</td></tr>
        </table>
        
        <h4>–§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞:</h4>
        <div style="font-size: 0.9em;">
            ${activeRisks.length > 0 ? 
                activeRisks.map(risk => `<span class="risk-factor">${risk}</span>`).join('') :
                '<span style="color: green;">–ù–µ—Ç –∑–Ω–∞—á–∏–º—ã—Ö —Ñ–∞–∫—Ç–æ—Ä–æ–≤ —Ä–∏—Å–∫–∞</span>'
            }
        </div>
        
        ${patientData.diagnosis && patientData.diagnosis !== "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" ? `
            <h4>–î–∏–∞–≥–Ω–æ–∑:</h4>
            <div style="font-size: 0.9em; background: #e0e0e0; padding: 8px; border-radius: 4px;">
                ${patientData.diagnosis}
            </div>
        ` : ''}
    `;
    patientDiv.innerHTML = html;
}

async function startStream() {
    if (isStreaming) {
        alert('–£–∂–µ –∏–¥–µ—Ç —Å—Ç—Ä–∏–º–∏–Ω–≥! –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Å—Ç—Ä–∏–º —Å–Ω–∞—á–∞–ª–∞.');
        return;
    }
    
    const sid = document.getElementById("sid").value;
    const log = document.getElementById("log");
    const analysisDiv = document.getElementById("analysis");
    const predsDiv = document.getElementById("predictions");
    const statsDiv = document.getElementById("statistics");
    const patientDiv = document.getElementById("patientInfo");
    
    log.textContent = "";
    predsDiv.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π...";
    statsDiv.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...";
    analysisDiv.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏–∑–∞...";
    patientDiv.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞—Ü–∏–µ–Ω—Ç–∫–µ...";
    isStreaming = true;

    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞—Ü–∏–µ–Ω—Ç–∫–µ
    try {
        const patientResp = await fetch(`http://localhost:8001/sessions/${sid}/patient-info`);
        if (patientResp.ok) {
            const patientData = await patientResp.json();
            updatePatientInfo(patientData.patient_info);
        }
    } catch (err) {
        console.log("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞—Ü–∏–µ–Ω—Ç–∫–µ:", err);
        patientDiv.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–∞—Ü–∏–µ–Ω—Ç–∫–µ";
    }

    // 2. WebSocket –¥–ª—è –ø–æ—Ç–æ–∫–∞
    ws = new WebSocket(`ws://localhost:8001/ws/stream/${sid}`);

    ws.onmessage = function(event) {
        const msg = JSON.parse(event.data);

        if (msg.type === "frame") {
            log.textContent += `–í—Ä–µ–º—è: ${msg.time.toFixed(2)}s | BPM: ${msg.bpm ?? "‚Äî"} | Uterus: ${msg.uterus ?? "‚Äî"}\n`;
        } else if (msg.type === "meta") {
            log.textContent += `=== META ===\n${JSON.stringify(msg.meta, null, 2)}\n`;
        } else if (msg.type === "prediction") {
            updateStatistics(msg);
            updatePredictions(msg);
            log.textContent += `--- –ü–†–ï–î–°–ö–ê–ó–ê–ù–ò–ï (${msg.timestamp.toFixed(1)}s) ---\n`;
        } else if (msg.type === "error") {
            log.textContent += `‚ùå –û–®–ò–ë–ö–ê: ${msg.message}\n`;
        }

        log.scrollTop = log.scrollHeight;
    };

    ws.onclose = function() {
        log.textContent += "\n‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ";
        isStreaming = false;
    };

    ws.onerror = function() {
        log.textContent += "\n‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è";
        isStreaming = false;
    };

    // 3. –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏–∑ –ø–æ –≤—Å–µ–π —Å–µ—Å—Å–∏–∏ (REST API)
    try {
        const resp = await fetch(`http://localhost:8001/sessions/${sid}/analysis`);
        if (!resp.ok) {
            analysisDiv.textContent = "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: " + resp.statusText;
            return;
        }
        const data = await resp.json();

        let html = `
          <b>–°–µ—Å—Å–∏—è:</b> ${data.meta.session_id} <br>
          <b>–ì—Ä—É–ø–ø–∞:</b> ${data.meta.group} <br>
          <b>–ü–∞–ø–∫–∞:</b> ${data.meta.folder_id} <br>
          <b>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</b> ${data.features.duration_seconds?.toFixed(1) ?? "‚Äî"} —Å–µ–∫<br>
          <b>–í—Å–µ–≥–æ —Ç–æ—á–µ–∫:</b> ${data.features.total_samples}<br>
          <br>
          <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ BPM:</b><br>
          <table>
            <tr><th>–°—Ä–µ–¥–Ω–µ–µ</th><th>–ú–µ–¥–∏–∞–Ω–∞</th><th>–ú–∞–∫—Å–∏–º—É–º</th><th>–ú–∏–Ω–∏–º—É–º</th><th>–°—Ç–∞–Ω–¥. –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ</th><th>–¢–æ—á–µ–∫ BPM</th></tr>
            <tr>
              <td>${data.features.mean_bpm?.toFixed(1) ?? "‚Äî"}</td>
              <td>${data.features.median_bpm?.toFixed(1) ?? "‚Äî"}</td>
              <td>${data.features.max_bpm?.toFixed(1) ?? "‚Äî"}</td>
              <td>${data.features.min_bpm?.toFixed(1) ?? "‚Äî"}</td>
              <td>${data.features.std_bpm?.toFixed(1) ?? "‚Äî"}</td>
              <td>${data.features.bpm_samples ?? "‚Äî"}</td>
            </tr>
          </table>
          
          <br>
          <b>–°–æ–±—ã—Ç–∏—è:</b><br>
          <table>
            <tr><th>–î–µ—Ü–µ–ª–µ—Ä–∞—Ü–∏–∏</th><th>–¢–∞—Ö–∏–∫–∞—Ä–¥–∏—è</th><th>–ë—Ä–∞–¥–∏–∫–∞—Ä–¥–∏—è</th></tr>
            <tr>
              <td>${data.features.decel_count ?? 0}</td>
              <td>${data.features.tachy_count ?? 0}</td>
              <td>${data.features.brady_count ?? 0}</td>
            </tr>
          </table>
        `;
        analysisDiv.innerHTML = html;
    } catch (err) {
        analysisDiv.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏–∑–∞: " + err;
    }
}

function stopStream() {
    if (ws) {
        ws.close();
    }
    isStreaming = false;
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (ws) {
        ws.close();
    }
});
</script>
</body>
</html>